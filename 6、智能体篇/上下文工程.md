构建Manus时的上下文工程经验教训
在智能体系统的构建中，精心设计的上下文比模型本身更能决定成败

作者：Yichao 'Peak' Ji
日期：2025年7月18日

抉择时刻：微调还是上下文工程？
在Manus项目的早期，团队和我面临一个关键的战略抉择：是基于开源基座训练端到端的智能体模型，还是直接在前沿大模型的上下文学习能力之上构建智能体？

这个问题的答案，对我而言，源于十年前做NLP时的痛苦经历。在BERT时代（如今已过去七年），我们必须针对每个任务进行微调，一次迭代动辄数周；而模型本身又太小，缓慢的反馈循环直接扼杀了快速试错的可能性。后来我创办的语义搜索与开放信息抽取公司，就因为这条技术死胡同，被GPT-3和Flan-T5一夜之间"降维打击"。

那段经历让我得出了一个坚定判断：Manus必须押注"上下文工程"——将改进周期从周级降到小时级，同时让产品与底层模型解耦。当模型能力如潮水般上涨时，我们选择当随波起伏的船，而不是插在海底的固定柱子。

上下文工程的现实：不优雅但有效
上下文工程在实践中并不优雅。四年间，我们将智能体框架重写了四遍，每次都是因为找到了更好的上下文塑形方法。团队自嘲这套"手工调参+经验试错"的流程为"随机梯度下降（SGD）"——方法很土，但确实管用。

这篇文章将分享我们通过"SGD"获得的局部最优经验，希望能帮助正在构建智能体的你少踩几次坑。

核心经验教训
一、围绕KV-Cache进行设计
如果只能关注一个指标，我会选择"KV-Cache命中率"。它直接决定了系统的延迟和成本。

智能体每步都需要将"行动-观察"对追加进历史，输入输出token比例经常达到100:1。而缓存命中与未命中的成本差异可达10倍（以Claude Sonnet为例，缓存状态下为0.3美元/百万token，未缓存状态下为3美元/百万token）。

实操建议：

保持prompt前缀绝对稳定：自回归模型即使只差一个token，也会导致后续缓存全部失效。切勿在系统提示中加入秒级时间戳

上下文只能追加，不能回改：序列化必须保持确定性——JSON key顺序不稳定会悄悄击穿缓存

合理使用断点：如果平台不支持自动前缀缓存，就手动设置断点，至少保证断点包含系统提示的末尾部分

自托管优化：使用vLLM自托管时记得开启prefix-caching，并用session ID将请求路由到同一worker

二、掩码而非删除
随着MCP等协议的普及，工具空间正在爆发式增长。动态加载/卸载工具看似自然，却带来两大问题：

工具定义通常位于上下文前部，一旦修改就会导致整个缓存失效

历史动作仍然引用已卸载工具，模型会产生幻觉或违反schema

Manus的解决方案是采用"状态机+logits掩码"：工具始终保留在上下文中，通过在解码阶段掩蔽不允许的token，实现"指定子集函数调用"。我们将工具命名空间化（如browser_* / shell_*），利用response prefill即可按前缀进行掩码，无需带状态的logits processor。

三、将文件系统视为上下文
即使拥有128K token的上下文窗口，仍然不够用吗？观察数据（网页、PDF等）一不小心就会爆窗，而过度压缩又会丢失关键信息。

Manus采用"可恢复压缩"作为默认策略：只要URL或文件路径仍在沙箱内，内容就可以被模型重新读取。这样，文件系统就成为了无限外存；模型学会"主动记笔记"与"按需读取"。

这也为未来的SSM（状态空间模型）指明了一个方向：即使没有全局注意力机制，也能通过外部文件实现长期记忆，成为真正的Neural Turing Machine继承者。

四、用"背诵"牵引注意力
复杂任务平均需要50步，模型容易在过程中"迷失方向"。Manus通过在todo.md中不断重写并勾选任务清单，将全局目标始终保持在上下文的尾部，利用近期注意力偏差来避免"lost-in-the-middle"现象。

这是用自然语言实现的软性attention控制，无需任何架构改动。

五、把错误留在现场
智能体必然会犯错。清除失败轨迹、静默重试看似干净，实际上剥夺了模型自我修正的证据。

Manus坚持"错误现场保留"原则：让模型看到堆栈跟踪、环境返回码，它会在先验知识中下调相似动作的得分。错误恢复能力才是智能体真实表现的核心指标，但这一指标被大多数基准测试所忽略。

六、警惕Few-Shot的"节奏效应"
大模型本质上是模式复读机。如果上下文中充满相似的"行动-观察"对，模型会产生惯性重复，导致漂移或幻觉。

Manus在模板、措辞、字段顺序中主动加入受控噪声，打破这种节奏——不要被自己的"Few-Shot"示例带进死胡同。

结语
上下文工程是一门新兴的实验科学，但已成为智能体系统绕不开的基石。无论模型多么强大，都离不开记忆、环境与反馈的支持；而这三者的呈现形式，正是我们每天精心雕琢的那段prompt。

Manus在百万级用户的真实负载中验证了上述原则——它们不是绝对真理，但足以让下一次迭代少一点血泪。智能体的未来，将由一个又一个被精心雕刻的上下文堆叠而成。

愿我们都能将这些上下文雕琢得更快、更稳、更经济。